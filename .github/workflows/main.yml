name: Java CI
permissions:
  contents: write

on:
  push:
    branches: [ "**" ]
  pull_request:

# Real-world CI notes:
# - This workflow runs unit and integration tests inside GitHub Actions.
# - The Create GitHub Release step is intentionally restricted so that
#   releases are only created when code reaches `main` or when a tag is
#   pushed (see the `if:` condition on the release step). This prevents
#   accidental releases from feature branches.

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ROOT_PASSWORD: example
          MYSQL_DATABASE: world
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -pexample"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      DB_URL: jdbc:mysql://127.0.0.1:3306/world?allowPublicKeyRetrieval=true&useSSL=false&serverTimezone=UTC
      DB_USER: root
      DB_PASS: example

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Wait for MySQL to be ready
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -pexample --silent; then
              echo "MySQL is up!"
              break
            fi
            echo "Waiting for MySQL..."
            sleep 2
          done

      - name: Import world database
        run: |
          mysql -h 127.0.0.1 -uroot -pexample world < db/world-db/world.sql

      - name: Run tests
        run: mvn -B clean test

      - name: List coverage files
        run: |
          echo "Listing target directory:"
          ls -R
          echo "Listing target/site:"
          ls target/site || true
          echo "Listing target/site/jacoco:"
          ls target/site/jacoco || true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: target/site/jacoco/jacoco.xml
          fail_ci_if_error: true
          flags: unittests
          name: java-coverage

      - name: Create GitHub Release
        if: ${{ github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/') }}
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          prerelease: false
          automatic_release_tag: "latest"
          files: |
            ./target/*.jar
